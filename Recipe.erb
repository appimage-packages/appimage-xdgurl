#!/bin/bash

APP=<%= proper_name %>
LOWERAPP=<%= name %>

# Get helper functions
wget -q https://github.com/probonopd/AppImages/raw/master/functions.sh -O ./functions.sh
. ./functions.sh
rm -f functions.sh

#get deps
yum -y install perl-URI.noarch gnome-common gnome-icon-theme gtk2-devel tkinter mesa-libGLU-devel gstreamer-devel webkitgtk-devel \
gstreamer-plugins-base-devel freeglut-devel

function get_assistant {
  # Build AppImageKit
if [ ! -d AppImageKit ] ; then
  git clone  --depth 1 https://github.com/probonopd/AppImageKit.git /AppImageKit
fi

cd /AppImageKit/
git_pull_rebase_helper
./build.sh

chmod a+x ./AppImageAssistant*

cd ..
}

#deps
wget http://python.org/ftp/python/2.7.6/Python-2.7.6.tar.xz
tar xf Python-2.7.6.tar.xz
cd Python-2.7.6
./configure --prefix=/usr/local --enable-unicode=ucs4 --enable-shared LDFLAGS="-Wl,-rpath /usr/local/lib"
make && make altinstall

# Python 3.3.5:
wget http://python.org/ftp/python/3.3.5/Python-3.3.5.tar.xz
tar xf Python-3.3.5.tar.xz
cd Python-3.3.5
./configure --prefix=/usr/local --enable-shared LDFLAGS="-Wl,-rpath /usr/local/lib"
make && make altinstall

# First get the setup script for Setuptools:
wget https://bootstrap.pypa.io/ez_setup.py

# Then install it for Python 2.7 and/or Python 3.3:
python2.7 ez_setup.py
python3.3 ez_setup.py

# Now install pip using the newly installed setuptools:
easy_install-2.7 pip
easy_install-3.3 pip

git clone https://github.com/wxWidgets/wxWidgets
cd wxWidgets
./configure --prefix=/usr/local --enable-shared LDFLAGS="-Wl,-rpath /usr/local/lib"
make && make altinstall


git clone https://github.com/xdgurl/xdgurl
cd xdgurl
make -j 8
make install

VERSION=$(git describe | sed -e 's/-g.*$// ; s/^v//')

cd ..

rm -rf /app || true # Clean up from previous runs
rm /out/* || true
mkdir -p /app/usr/bin /app/usr/lib /app/usr/share/mime /app/opt/rh /app/lib /out

APPDIR=/app/
cd $APPDIR

FILES=$(rpm -qla $LOWERAPP)
for FILE in $FILES ; do
  if [ -f $FILE ] ; then
    echo $FILE
    cp --parents -rfL $FILE ./
  fi
done

# Copy in the indirect dependencies
FILES=$(find . -type f -executable)
DEPS=""
for FILE in $FILES ; do
  ldd "${FILE}" | grep "=>" | awk '{print $3}' | xargs -I '{}' echo '{}' > DEPSFILE
done
DEPS=$(cat DEPSFILE  |sort | uniq)
for FILE in $DEPS ; do
  if [ -f $FILE ] ; then
    echo $FILE
    cp --parents -rfL $FILE ./
  fi
done
rm -f DEPSFILE

# We want everything in usr/ inside the AppDir
mv lib/* usr/lib/ || true
rm -rf ./lib* || true


delete_blacklisted
patch_usr
get_apprun
get_assistant
ARCH=$(arch)
cd /app

delete_blacklisted
patch_usr
cp -ru /usr/share/mime/* /app/usr/share/mime
update-mime-database /app/usr/share/mime/

copy_deps
mkdir -p /app/lib /app/usr/share /app/etc /app/opt/rh/ /app/bin
cp -rfv /lib64/*  /app/lib/
cp -rfv /usr/lib64/*  /app/lib/
cp -rfv /usr/share/tk* /app/usr/share/
cp -rfv /usr/local/* /app/usr/local/
cp -rfv /etc/* /app/etc/
mv  /AppImageKit/AppImageAssistant /app/
mv  /AppImageKit/AppImageExtract /app/
mv  /AppImageKit/AppImageMonitor /app/
rm  -rf ./opt/


# We don't bundle the developer stuff
rm -rf usr/include || true
rm -rf usr/lib/pkgconfig || true
rm -rf usr/share/gettext || true
rm -rf usr/share/pkgconfig || true
rm -rf usr/share/cmake3 || true
rm -rf usr/share/cmake || true
rm -rf rm -rf ./usr/mkspecs/ || true
find . -name '*.a' -exec rm {} \;

strip -g $(find usr) || true


export PYTHONPATH=/usr/local/lib/python2.7/site-packages:$PYTHONPATH

cd /
# Copy desktop file in place
DESKTOP=$(find . -name "*$LOWERAPP.desktop" | head -n 1)
cp $DESKTOP . || true
echo $DESKTOP
echo Icon=emblem-web >> $LOWERAPP.desktop
cat $LOWERAPP.desktop
VERSION=$(rpm -qa | grep ^$LOWERAPP- | cut -d - -f 2)
echo $VERSION
# Add desktop integration
get_desktopintegration <%= name %>
mv /usr/bin/$LOWERAPP.wrapper /app/usr/bin/
mkdir -p /$APP/$APP.AppDir
cd /$APP/

mv ../app/* $APP.AppDir/
cp /$LOWERAPP.desktop  $APP.AppDir/
cp /usr/share/icons/gnome/scalable/emblems/emblem-web.svg  $APP.AppDir/
/AppImageKit/AppImageAssistant.AppDir/package <%= proper_name %>.AppDir/ /out/$APP-$VERSION-$ARCH.AppImage
